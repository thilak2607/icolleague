<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expenses - iColleague</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="brand">
                    <div class="brand-icon">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="brand-name">iColleague</div>
                </div>
            </div>
            <div class="sidebar-nav">
                <a href="{{ url_for('dashboard') }}" class="nav-item">
                    <i class="nav-icon fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="{{ url_for('assistant') }}" class="nav-item">
                    <i class="nav-icon fas fa-robot"></i>
                    <span>Assistant</span>
                </a>
                <a href="{{ url_for('contacts') }}" class="nav-item">
                    <i class="nav-icon fas fa-address-book"></i>
                    <span>Contacts</span>
                </a>
                <a href="{{ url_for('expenses') }}" class="nav-item active">
                    <i class="nav-icon fas fa-rupee-sign"></i>
                    <span>Expenses</span>
                    <span class="badge badge-primary" style="margin-left: auto;">
                        ₹{{ "%.2f"|format(summary.pending/100000) }}L
                    </span>
                </a>
                <a href="{{ url_for('holidays') }}" class="nav-item">
                    <i class="nav-icon fas fa-umbrella-beach"></i>
                    <span>Holidays</span>
                </a>
                <a href="{{ url_for('logout') }}" class="nav-item" style="color: #ef4444; margin-top: 2rem;">
                    <i class="nav-icon fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </a>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <div class="header-title">
                    <h1><i class="fas fa-rupee-sign"></i> Expense Management</h1>
                    <p>Submit and track your expense claims</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newExpenseModal">
                        <i class="fas fa-plus"></i> New Expense
                    </button>
                </div>
            </div>

            <!-- Expense Summary -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>₹{{ "%.2f"|format(summary.total/100000) }}L</h3>
                        <p>Total Expenses</p>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(45deg, #3b82f6, #1d4ed8); color: white;">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>₹{{ "%.2f"|format(summary.pending/100000) }}L</h3>
                        <p>Pending Claims</p>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(45deg, #f59e0b, #d97706); color: white;">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>₹{{ "%.2f"|format(summary.approved/100000) }}L</h3>
                        <p>Approved</p>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(45deg, #10b981, #059669); color: white;">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-info">
                        <h3>₹{{ "%.2f"|format(summary.reimbursed/100000) }}L</h3>
                        <p>Reimbursed</p>
                    </div>
                    <div class="stat-icon" style="background: linear-gradient(45deg, #8b5cf6, #7c3aed); color: white;">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
            </div>

            <!-- Expense Table -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">Recent Expense Claims</h3>
                    <div>
                        <button class="btn btn-sm btn-outline">
                            <i class="fas fa-download"></i> Export
                        </button>
                        <button class="btn btn-sm btn-outline">
                            <i class="fas fa-filter"></i> Filter
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="expense-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Category</th>
                                    <th>Description</th>
                                    <th>Project</th>
                                    <th>Amount</th>
                                    <th>GST</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for expense in expenses %}
                                <tr>
                                    <td>{{ expense.date }}</td>
                                    <td>
                                        <span class="badge badge-primary">{{ expense.category }}</span>
                                    </td>
                                    <td>{{ expense.description }}</td>
                                    <td>{{ expense.project }}</td>
                                    <td class="font-bold">₹{{ "%.2f"|format(expense.amount) }}</td>
                                    <td>₹{{ "%.2f"|format(expense.gst_amount) }}</td>
                                    <td class="font-bold" style="color: var(--primary-color);">
                                        ₹{{ "%.2f"|format(expense.total_amount) }}
                                    </td>
                                    <td>
                                        <span class="expense-status status-{{ expense.status|lower }}">
                                            {{ expense.status }}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="display: flex; gap: 0.5rem;">
                                            <button class="btn btn-sm btn-outline">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if expense.status == 'Pending' %}
                                            <button class="btn btn-sm btn-outline" style="color: var(--danger-color);">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                            {% endif %}
                                            {% if expense.receipt %}
                                            <button class="btn btn-sm btn-outline">
                                                <i class="fas fa-receipt"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Expense Categories -->
            <div class="card mt-4">
                <div class="card-header">
                    <h3 class="card-title">Expense Categories</h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for category in categories %}
                        <div class="col-4">
                            <div class="d-flex align-center justify-between p-3" 
                                 style="background: var(--light-bg); border-radius: var(--border-radius-md); margin-bottom: 0.5rem;">
                                <div class="d-flex align-center gap-2">
                                    <div class="stat-icon" style="width: 36px; height: 36px; font-size: 1rem;">
                                        <i class="fas fa-{{ 
                                            'plane' if category == 'Travel' 
                                            else 'utensils' if category == 'Food' 
                                            else 'bed' if category == 'Accommodation'
                                            else 'laptop' if category == 'Equipment'
                                            else 'shopping-cart'
                                        }}"></i>
                                    </div>
                                    <span>{{ category }}</span>
                                </div>
                                <span class="font-bold">₹12,500</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- New Expense Modal -->
    <div class="modal" id="newExpenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-plus"></i> New Expense Claim</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="expenseForm">
                        <div class="form-group">
                            <label class="form-label">Category</label>
                            <select class="form-control" name="category" required>
                                <option value="">Select Category</option>
                                {% for category in categories %}
                                <option value="{{ category }}">{{ category }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Description</label>
                            <input type="text" class="form-control" name="description" 
                                   placeholder="Brief description of expense" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Amount (₹)</label>
                            <input type="number" class="form-control" name="amount" 
                                   placeholder="0.00" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Project</label>
                            <input type="text" class="form-control" name="project" 
                                   placeholder="Project code or name">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Receipt (Optional)</label>
                            <input type="file" class="form-control" name="receipt" 
                                   accept=".pdf,.jpg,.png">
                            <small class="text-muted">Upload receipt in PDF, JPG or PNG format</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="submitExpense">Submit Claim</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS for Modal -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Modal handling
            const modal = new bootstrap.Modal(document.getElementById('newExpenseModal'));
            
            // Submit expense
            document.getElementById('submitExpense').addEventListener('click', async function() {
                const form = document.getElementById('expenseForm');
                const formData = new FormData(form);
                
                const expenseData = {
                    category: formData.get('category'),
                    description: formData.get('description'),
                    amount: formData.get('amount'),
                    project: formData.get('project'),
                    receipt: formData.get('receipt')?.name || ''
                };
                
                try {
                    const response = await fetch('/api/expenses/submit', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(expenseData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        alert('Expense submitted successfully!');
                        modal.hide();
                        location.reload();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to submit expense. Please try again.');
                }
            });
        });
    </script>
</body>
</html>
